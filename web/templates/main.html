<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Demo</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script>
    const createChatLi = (message, className) => {
      const chatLi = document.createElement("li");
      chatLi.classList.add("chat", className);
      let chatContent = 
        className === "chat-outgoing" ? `<p>${message}</p>` : `<p>${message}</p>`;
      chatLi.innerHTML = chatContent;
      return chatLi;
    };

    function closeChat() {
      let ui = document.querySelector(".chatBot");
      if (ui.style.display != 'none') {
          ui.style.display = "none";
          document.querySelector(".end").style.display = "block";
      }
    }

    function reset() {
      // GET /main to restart the chat
      window.location.href = "/main";
    }

    $(document).ready(function(){
      const opt_elmt = document.getElementById("opt");
      const chatbox = document.querySelector(".chatbox");
      $('#sendBTN').click(function(){
        var input = $('#user_input').val();
        if (!input) return;

        chatbox.insertBefore(createChatLi(input, "chat-outgoing"), opt_elmt);
        chatbox.scrollTo(0, chatbox.scrollHeight);
        $('#user_input').val("");

        const incomingChatLi = createChatLi("Thinking...", "chat-incoming");
        chatbox.insertBefore(incomingChatLi, opt_elmt);
        chatbox.scrollTo(0, chatbox.scrollHeight);

        $.ajax({
          method: "POST",
          url: "/func",
          data: { user_input: input}
        })
        .done(function( msg ) {
          incomingChatLi.innerHTML = `<p>The possible disease you have is 
            <strong>${msg}</strong></p>`;
          var drugChatLi = 
            createChatLi("Do you want to get information about disease-related over-the-counter drugs?", "chat-incoming");
          chatbox.insertBefore(drugChatLi, opt_elmt);
          chatbox.scrollTo(0, chatbox.scrollHeight);
          $('#opt').show();

        });
      });

      $('#opt_no').click(function(){
        $('#opt').hide();
      });
      $('#opt_yes').click(function(){
        $('#opt').hide();
        var option = 'yes';
        outgo_lis = document.querySelectorAll('.chat-outgoing');
        var input = outgo_lis[outgo_lis.length - 1].innerText;
        const incomingChatLi = createChatLi("Thinking...", "chat-incoming");
        chatbox.insertBefore(incomingChatLi, opt_elmt);
        $.ajax({
          method: "POST",
          url: "/drugs",
          data: { option: option, user_input: input}
        })
        .done(function( msg ) {
          // msg is a json with key and value
          if (Object.keys(msg).length == 0) {
            incomingChatLi.innerHTML = `<p>Sorry, no OTC recommendations found.</p>`;
          }
          else{
            for (var key in msg) {
              if (key == "1") incomingChatLi.innerHTML = `<p>Top ${Object.keys(msg).length} OTC recommendations:</p>`;
              incomingChatLi.innerHTML += `<p>${key}. ${msg[key]}</p>`;
            }
          }
          chatbox.scrollTo(0, chatbox.scrollHeight);
        });
      });
    });
  </script>
</head>
<body>
  <div class="chatBot">
    <header>
      <h2>Project Demo</h2>
      <span alt="Close" onclick="closeChat()"
				id="cross">X</span>
    </header>
  
    <ul class="chatbox">
      <li class="chat-incoming chat">
        <p>Hi! Please type your situation here in English</p>
      </li>
      <li class="chat-incoming chat" id="opt">
        <p>
          <button id="opt_yes" style="background-color: green;">
            Yes</button>
          <button id="opt_no" style="background-color: red;">
            No</button>
        </p>
      </li>
    </ul>
    <div class="chat-input">
      <textarea id="user_input"
        placeholder="Enter a message..."></textarea>
      <button id="sendBTN">Send</button>
    </div>
  </div>
  <div class="end">
    <p class="lastMessage">Thanks for using our service!</p>
    <button id="endBTN" onclick="reset()">Restart</button>
  </div>
  
  <div class="footer">
    <p>資訊僅供參考</p>
  </div>
</body>
</html>